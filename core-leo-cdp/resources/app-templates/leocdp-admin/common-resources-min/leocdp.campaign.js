'use strict';var campaignView=function(c){location.hash="calljs-leoCdpRouter('Campaign_Info','"+c+"')"},campaignEditor=function(c){location.hash="calljs-leoCdpRouter('Campaign_Editor','"+c+"')"},campaignRunImmediately=function(c){console.log("campaignRunImmediately "+c)},campaignScheduler=function(c){console.log("campaignScheduler "+c)},campaignListRefresh=function(){var c=(new Date).getTime();location.hash="#calljs-leoCdpRouter('Automated_Campaigns','_refresh_"+c+"')"};
function loadCampaignList(){var c=getUserSession();c&&$("#campaign-list").DataTable({processing:!1,serverSide:!1,serverMethod:"POST",ajax:{url:baseLeoAdminUrl+"/cdp/campaigns/filter",contentType:"application/json",beforeSend:function(b){b.setRequestHeader("leouss",c)},data:function(b){console.log(b);return JSON.stringify(b)}},columnDefs:[{render:function(b,a,d){b=textTruncate(b,60);return'\x3ca title\x3d"'+d.name+'" href\x3d"javascript:campaignView(\''+(d.id+"')\" \x3e")+b+"\x3c/a\x3e"},targets:0},
{render:function(b,a,d){a="USER_DEFINED";1===b?a="BRAND_AWARENESS":2===b?a="LEAD_GENERATION":3===b?a="CONVERSION_OPTIMIZATION":4===b?a="RETENTION_OPTIMIZATION":5===b?a="CROSS_SELLING":6===b?a="UPSELLING":7===b&&(a="REFERRAL_PROGRAM");return'\x3cdiv class\x3d"datatable_text text-center"\x3e'+a+"\x3c/div\x3e"},targets:1},{render:function(b,a,d){a="DRAFT";1===b?a="PLANNED":2===b?a="IN_PROGRESS":3===b?a="COMPLETED":4===b?a="CANCELED":-1===b&&(a="DELETED");return'\x3cdiv class\x3d"datatable_text text-center"\x3e'+
a+"\x3c/div\x3e"},targets:2},{render:function(b,a,d){return'\x3cdiv class\x3d"datatable_text text-center"\x3e'+b+"\x3c/div\x3e"},targets:3},{render:function(b,a,d){return toLocalDateTime(b)},targets:4},{render:function(b,a,d){return b?toLocalDateTime(b):"-"},targets:5},{render:function(b,a,d){a="#calljs-leoCdpRouter('User_Login_Report','"+b+"')";return $("\x3ca/\x3e").attr("href",a).html(b)[0].outerHTML},targets:6},{render:function(b,a,d){b="javascript:campaignRunImmediately('"+d.id+"')";a="javascript:campaignScheduler('"+
d.id+"')";d='\x3cdiv style\x3d"text-align: left!important;padding-left:5px;"\x3e\x3ca class\x3d"control" title\x3d"Campaign Details" href\x3d"javascript:campaignView(\''+(d.id+'\')" \x3e\x3ci class\x3d"fa fa-info-circle" aria-hidden\x3d"true"\x3e\x3c/i\x3e View \x3c/a\x3e \x3cbr\x3e\x3ca class\x3d"control" title\x3d"Campaign Editor" href\x3d"javascript:campaignEditor(\'')+(d.id+'\')" \x3e\x3ci class\x3d"fa fa-pencil-square-o" aria-hidden\x3d"true"\x3e\x3c/i\x3e  Edit \x3c/a\x3e \x3cbr\x3e');return d=
d+('\x3ca class\x3d"control" title\x3d"Schedule campaign" href\x3d"'+a+'" \x3e\x3ci class\x3d"fa fa-clock-o" aria-hidden\x3d"true"\x3e\x3c/i\x3e Schedule \x3c/a\x3e  \x3cbr\x3e\x3ca class\x3d"control" title\x3d"Run campaign immediately" href\x3d"')+(b+'" \x3e\x3ci class\x3d"fa fa-play" aria-hidden\x3d"true"\x3e\x3c/i\x3e Run \x3c/a\x3e \x3c/div\x3e')},targets:7}],columns:[{data:"name"},{data:"type"},{data:"status"},{data:"targetedSegmentNames"},{data:"updatedAt"},{data:"lastRunAt"},{data:"ownerUsername"},
{data:"automatedFlow"}]})}
function initCampaignMetadata(c){var b=c.name;document.title="Campaign Editor: "+b;$("#campaign_name_header").text("Campaign: "+b);$("#campaign_description").val(c.description);$("#campaign_name").val(b).keyup(function(){c.name=$(this).val().trim();$("#campaign_name_header").text("Campaign: "+c.name)});$("#runAtDateAndTime").datetimepicker();null!=c.automatedFlowJson&&(b=Handlebars.compile(c.automatedFlowJson)({segment_name:"test",condition_name:"Today is the birthday of customer",condition_expression:'context.isCurrentDateEqualProfileBirthday("@{currentDate}")',
campaign_action_type:"email"}),b=JSON.parse(b),renderCampaignAutomatedFlow(b));getAllSegmentRefs(function(a){var d=$("#campaign_targetedSegmentIds").empty();a.forEach(function(f){d.append($("\x3coption /\x3e").attr("value",f.id).text(f.name))});$("#campaign_targetedSegmentIds").chosen({width:"100%",no_results_text:"No data available!"}).trigger("chosen:updated")});$("#campaign_condition").chosen({width:"100%",no_results_text:"No data available!"}).change(function(){var a=$(this).val();console.log(a);
"getEventAtUrl"===a?($("#runAtDateAndTimeForCondition").hide(),$("#eventMetricWithUrlForCondition").show()):"runAtDateAndTime"===a&&($("#eventMetricWithUrlForCondition").hide(),$("#runAtDateAndTimeForCondition").show())}).trigger("chosen:updated");$("#campaign_action_type").chosen({width:"100%",no_results_text:"No data available!"}).change(function(){var a=$(this).val();console.log(a);$("#frequencyCappingType").text(a.toUpperCase())}).trigger("chosen:updated");$("#frequencyCappingType").text($("#campaign_action_type").find(":selected").val());
$("#frequencyCappingTimeUnit").chosen({width:"100%",no_results_text:"No data available!"}).change(function(){var a=$(this).val();console.log(a)}).trigger("chosen:updated");loadEventMetricsForCampaignEventTrigger([])}var automatedFlowJsonData={};
function loadCampaignEditor(c){var b=$("#campaign_editor_loader"),a=$("#campaign_editor_div");LeoAdminApiUtil.callPostAdminApi(baseLeoAdminUrl+"/cdp/campaign/get",{id:c},function(d){b.hide();a.show();0===d.httpCode&&""===d.errorMessage?(d.canEditData?$("button.data-control-edit").click(function(){location.hash="calljs-leoCdpRouter('Campaign_Editor','"+c+"')"}):$("button.data-control-edit").attr("disabled","disabled"),d.data&&initCampaignMetadata(d.data)):LeoAdminApiUtil.logErrorPayload(d)})}
function loadEventMetricsForCampaignEventTrigger(c){LeoAdminApiUtil.getSecuredData("/cdp/funnel/event-metrics",{},function(b){var a="";b.data.forEach(function(d){a=c.includes(d.eventName)?a+('\x3coption selected value\x3d"'+d.id+'"\x3e'+d.eventLabel+"\x3c/option\x3e"):a+('\x3coption value\x3d"'+d.id+'"\x3e'+d.eventLabel+"\x3c/option\x3e")});$("#eventForCampaignCondition").html(a).chosen({width:"100%",no_results_text:"Oops, nothing found!"}).change(function(){var d=$(this).val();console.log(d)}).trigger("chosen:updated")})}
function renderCampaignAutomatedFlow(c){automatedFlowJsonData=c;console.log("flowJsonData \n ",c);c=jsonToMermaid(c);console.log("jsonToMermaid \n ",c);mermaid.initialize({startOnLoad:!1,securityLevel:"loose",useMaxWidth:!0});mermaid.render("id",c).then(({svg:b,bindFunctions:a})=>{var d=document.getElementById("campaignAutomatedFlow");d.innerHTML=b;a&&a(d)})}function automatedFlowNodeClick(c){console.log(c);notifySuccessMessage(c)}
function mermaidToJSON(c){c=c.split("\n").map(a=>a.trim()).filter(a=>a);const b=automatedFlowJsonData;b.rules=[];c.forEach(a=>{a=a.trim();try{if(a.startsWith("flowchart"))b.type="flowchart";else if(a.includes("--\x3e")){var [d,f]=a.split("--\x3e"),[,e,g]=f.includes("|")?f.split("|"):[null,f];e=e?e.trim():null;g=g?g.trim().replace(/ \[\[|\]\] /g,""):e;b.rules.push({start:d.trim(),conditionResult:e&&e!=g?e:null,end:g})}else if(a.includes("[")){const h=a.split("[")[0].trim(),l=a.match(/\[(.*?)\]/)?.[1].trim();
var k=b.nodes[h];"object"===typeof k?(k.id=h,k.label=l):b.nodes[h]={id:h,label:l}}else console.log("mermaidToJSON, skip line: ",a)}catch(h){console.log("error",a)}});return b}
function jsonToMermaid(c){let b=`${c.type} ${"LR"}\n`;Object.values(c.nodes).forEach(a=>{b+=`${a.id}[${a.label}]\n`;b+=`click ${a.id} href "javascript:automatedFlowNodeClick('${a.id}')"\n`});c.rules.forEach(a=>{a.conditionResult?(a.conditionResult=a.conditionResult,b+=`${a.start} -->|${a.conditionResult}| ${a.end}\n`):b+=`${a.start} --> ${a.end}\n`});return b};