<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>LEO Personalization Manual Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body {
            background: #f5f7fa;
            color: #1f2937;
        }

        header {
            background: linear-gradient(135deg, #0d1117, #111827);
            color: #fff;
        }

        header h1 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        header p {
            margin: 0;
            opacity: 0.8;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        }

        .card h5 {
            font-weight: 600;
        }

        .personalization-zone {
            border: 2px dashed #3b82f6;
            border-radius: 12px;
            background: #ffffff;
            padding: 20px;
        }

        .personalization-zone strong {
            display: block;
            margin-bottom: 12px;
            color: #1d4ed8;
        }

        footer {
            color: #6b7280;
            font-size: 0.9rem;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

</head>

<body>

    <!-- ================= HEADER ================= -->
    <header class="py-4 mb-4">
        <div class="container">
            <h1 class="mb-1">LEO Personalization Demo</h1>
            <p>Manual Visitor & Event Control Panel</p>
        </div>
    </header>

    <main class="container mb-5">

        <div class="row g-4">

            <!-- ================= VISITOR ================= -->
            <div class="col-lg-6">
                <div class="card p-4 h-100">
                    <h5 class="mb-3">Visitor Identity</h5>
                    <p class="text-muted small mb-3">
                        Explicitly set or override the <code>leo_vid</code> for testing personalization.
                    </p>

                    <div class="row g-2 align-items-center">
                        <div class="col-md-8">
                            <input id="leoVidInput" class="form-control" placeholder="e.g. vid_123" />
                        </div>
                        <div class="col-md-4 d-grid">
                            <button class="btn btn-primary" onclick="applyVisitorId()">
                                Apply Visitor
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= ITEM VIEW ================= -->
            <div class="col-lg-6">
                <div class="card p-4 h-100">
                    <h5 class="mb-3">Simulate Item View</h5>
                    <p class="text-muted small mb-3">
                        Trigger an <code>item-view</code> event with one or more product identifiers.
                    </p>

                    <div class="row g-2 align-items-center">
                        <div class="col-md-8">
                            <input id="productIdsInput" class="form-control" placeholder="AAPL, MSFT, GOOG" />
                        </div>
                        <div class="col-md-4 d-grid">
                            <button class="btn btn-outline-primary" onclick="simulateItemView()">
                                Send Event
                            </button>
                        </div>
                    </div>

                    <div class="form-text mt-2">
                        Comma-separated values, sent as <code>productids[]</code>
                    </div>

                    <div class="alert alert-success" role="alert" id="eventResult" style="display: none;"></div>
                </div>
            </div>

        </div>

        <!-- ================= PERSONALIZATION ================= -->
        <div class="mt-5">
            <div class="personalization-zone">
                <strong>ðŸ”® Personalized Recommendations (LEO Engine)</strong>
                <script id="leo_recommender_45ePNkROy1pGi5Dc6pDnn2"></script>
            </div>
        </div>

    </main>

    <footer class="text-center py-4">
        LEO Activation â€¢ Manual Personalization Trigger
    </footer>

    <!-- ===================================================== -->
    <!-- MANUAL CONTROLS (UNCHANGED)                           -->
    <!-- ===================================================== -->
    <script>
        const OBSERVER_ID = "45ePNkROy1pGi5Dc6pDnn2";

        function applyVisitorId() {
            const vid = $("#leoVidInput").val().trim();
            if (!vid) return alert("leo_vid is required");
            localStorage.setItem("leocache-leocdp_vid", vid);

            document.querySelectorAll(`iframe[id^="${OBSERVER_ID}_leo_iframe_"]`).forEach(el => el.remove());

            renderLeoPersonalization(vid);
        }

        function simulateItemView() {
            const productids = document.getElementById("productIdsInput").value.trim();
            if (!productids) return alert("productids required");

            LeoObserver.recordEventItemView(productids);
        }

        function renderLeoPersonalization(vid) {
            const anchorId = "leo_recommender_" + OBSERVER_ID;
            const cb = Math.floor(Math.random() * 100000);
            let src = "https://obs.example.com/ris/html/products";

            src += "?visid=" + encodeURIComponent(vid);
            src += "&obsid=" + OBSERVER_ID;
            src += "&tpurl=" + encodeURIComponent(location.href);
            src += "&cb=" + cb;

            const container = document.getElementById(anchorId).parentElement;
            const iframe = document.createElement("iframe");

            iframe.id = OBSERVER_ID + "_leo_iframe_" + cb;
            iframe.src = src;
            iframe.style = "width:100%;height:800px;border:none;";

            container.appendChild(iframe);
        }
    </script>

    <!-- ===================================================== -->
    <!-- CDP OBSERVER BOOTSTRAP (UNCHANGED)                    -->
    <!-- ===================================================== -->
    <script>
        (function () {
            window.leoObserverId = OBSERVER_ID;
            window.leoObserverBatchSize = 10;
            window.leoObserverLogDomain = "obs.example.com";
            window.leoObserverCdnDomain = "leocdp.example.com/public";

            window.srcTouchpointName = encodeURIComponent(document.title);
            window.srcTouchpointUrl = encodeURIComponent(location.href);

            var leoproxyJsPath = '/js/leo-observer-src/leo.proxy.js';
            var src = location.protocol + '//' + window.leoObserverCdnDomain + leoproxyJsPath;
            var jsNode = document.createElement('script');
            jsNode.async = true; jsNode.defer = true; jsNode.src = src;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jsNode, s);
        })();

        var LeoObserver = {};

        LeoObserver.recordEventItemView = function (productids) {
            LeoObserverProxy.recordViewEvent("item-view", {
                productids: productids,
                idtype: "TICKER"
            });
            $("#eventResult").text(`Sent item-view event with productids: [${productids}]`).fadeIn().delay(2000).fadeOut();
        };

        function leoObserverProxyReady() {
            console.log("leoObserverProxyReady called");
            LeoObserverProxy.synchLeoVisitorId(function (vid) {
                console.log("Visitor synced:", vid);
            });
        }

        $(document).ready(function () {

            function applyVidFromHash() {
                // Expect format: #vid=xxxx
                var hash = location.hash || "";
                var vid = "";

                if (hash.indexOf("#vid=") === 0) {
                    vid = hash.substring(5).trim();
                }

                if (vid.length > 0) {
                    $("#leoVidInput").val(vid);
                    applyVisitorId();
                }
            }

            // Initial load
            applyVidFromHash();

            // Listen to hash changes
            $(window).on("hashchange", function () {
                applyVidFromHash();
            });

        });

    </script>

</body>

</html>